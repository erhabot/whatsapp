"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { newObj[key] = obj[key]; } } } newObj.default = obj; return newObj; } }var I=Object.defineProperty;var U=(o,e)=>{for(var t in e)I(o,t,{get:e[t],enumerable:!0})};var _cheerio = require('cheerio');var _gaxios = require('gaxios'); var m = _interopRequireWildcard(_gaxios); var h = _interopRequireWildcard(_gaxios);var c=o=>{let e=_cheerio.load.call(void 0, o),t=n=>({url:n.attribs.href,source:_cheerio.load.call(void 0, n).text().trim()});return{resolution:e("strong").text().trim(),size:e("i").text().trim(),urls:e("a").map((n,s)=>t(s)).toArray()}},w=async(o,e)=>{var a,i;if(e.type!=="episode")throw new TypeError("Invalid slug.type");let t=await o.request({url:"/".concat(e.type,"/",encodeURIComponent(e.slug))});if(t.status!==200)return;let n=_cheerio.load.call(void 0, t.data),s=(a=n("#lightsVideo iframe").attr("src"))!=null?a:"-",r=async()=>{var S;let p=await m.request({url:s,baseUrl:""});if(p.status!==200)throw new Error("Unexpected Response#status from frameUrl");let d=/\[{'file':'(.+)','type/gi.exec(p.data);return(S=d==null?void 0:d.at(1))!=null?S:void 0};return{title:n("h1.posttl").text().trim(),postedBy:n(".kategoz span").eq(0).text().replace(/posted by/gi,"").trim(),releasedTime:n(".kategoz span").eq(1).text().replace(/release on/gi,"").trim(),downloads:n(".download ul li").map((p,x)=>c(x)).toArray(),url:t.request.responseURL,iframeStreamUrl:s,getStreamUrl:r,async stream(){if(s==="-")throw new Error("Unexpected frameUrl");let p=await r();if(!(p!=null&&p.length))throw new Error("Fail to extract the streamUrl");return(await m.request({url:p,responseType:"stream",baseUrl:""})).data},picture:(i=n(".cukder img.wp-post-image").attr("src"))!=null?i:"-",credit:n(".infozingle p").eq(0).text().trim()}};var q=(o,e,t)=>{let s=_cheerio.load.call(void 0, e).text().trim();if(o%2===0){let r={japanese:"japaneseName",studios:"studio",duration:"duration",type:"type",judul:"name",producers:"producers",aired:"aired",credit:"credit",rating:"rating",episodes:"totalEpisodes"},a=s.toLowerCase(),i=Reflect.get(r,a);Reflect.set(t,"_key",i),i&&Reflect.set(t,i,"")}else{let r=Reflect.get(t,"_key");if(r){let a=s.replace(/:/g,"").trim();Reflect.set(t,r,a),!isNaN(parseFloat(a))&&r!=="duration"?Reflect.set(t,r,parseFloat(a)):r==="aired"?Reflect.set(t,r,new Date(a)):r==="genres"&&Reflect.set(t,r,a.split(",").map(i=>i.trim())),Reflect.deleteProperty(t,"_key")}}},R=async(o,e)=>{if(e.type!=="batch")throw new TypeError("Invalid slug.type");let t=await o.request({url:"/".concat(e.type,"/",encodeURIComponent(e.slug)),follow:0});if(t.status!==200)return;let n=_cheerio.load.call(void 0, t.data),s={name:void 0,totalEpisodes:void 0,duration:void 0,producers:void 0,rating:0,genres:[],japaneseName:void 0,studio:void 0,url:t.request.responseURL,credit:void 0,aired:void 0,downloads:n(".download2 .batchlink ul li").map((r,a)=>c(a)).toArray()};return n(".infos").contents().filter((r,a)=>n(a).text().trim().length>1).each((r,a)=>{q(r,a,s)}),s};var v=async(o,e)=>{let t=_cheerio.load.call(void 0, o),n=i=>({name:_cheerio.load.call(void 0, i).text(),url:i.attribs.href}),[s,r]=[t("b").text().trim().toLowerCase(),t("span").contents().eq(1).text().replace(/:/g,"").trim()],a={japanese:"japaneseName",studio:"studio",durasi:"duration",status:"status",tipe:"type",judul:"name",produser:"producers"};if(s==="tanggal rilis")Reflect.set(e,"releasedAt",new Date(r));else if(s==="total episode")Reflect.set(e,"totalEpisodes",r==="?"?0:parseInt(r,10));else if(s==="skor")Reflect.set(e,"rating",parseFloat(r));else if(s==="genre")Reflect.set(e,"genres",t("a").map((i,p)=>n(p)).toArray());else{let i=Reflect.get(a,s);i&&Reflect.set(e,i,r)}},G=o=>{let e=_cheerio.load.call(void 0, o);return{title:e("a").text().trim(),url:e("a").attr("href"),uploadedAt:new Date(e(".zeebr").text().trim())}},A=async(o,e)=>{var r;if(e.type!=="anime")throw new TypeError("Invalid slug.type");let t=await o.request({method:"GET",url:"/".concat(e.type,"/",encodeURIComponent(e.slug))});if(t.status!==200)return;let n=_cheerio.load.call(void 0, t.data);if(/anime archive/gi.test(n("title").text().trim()))return;let s={name:"",image:(r=n("img.wp-post-image").attr("src"))!=null?r:"-",genres:[],url:t.request.responseURL,rating:0,status:"unknown",synopsis:n(".sinopc").text().trim(),japaneseName:"",type:"",totalEpisodes:0,duration:"",studio:"",releasedAt:new Date,producers:"",episodes:n(".episodelist ul li").map((a,i)=>G(i)).toArray()};return await Promise.all(n(".infozingle p").map(async(a,i)=>v(i,s)).toArray()),s};var f={};U(f,{resolveSlug:()=>g});var g=o=>{try{let e=new URL(o).pathname.split("/").filter(t=>t.length);return{type:e[0],slug:e[1]}}catch (e2){return}};var B=o=>{var n;let e=_cheerio.load.call(void 0, o),t=s=>({name:_cheerio.load.call(void 0, s).text().trim(),url:s.attribs.href});return{image:e("img").attr("src"),name:e("h2").text().trim(),url:e("h2 a").attr("href"),genres:e("div").eq(0).find("a").map((s,r)=>t(r)).toArray(),status:e("div").eq(1).eq(0).text().replace(/(status|\s+|:)/gi,"").trim().toLowerCase(),rating:(n=parseFloat(e("div").eq(2).eq(0).text().replace(/(rating|\s+|:)/gi,"").trim()))!=null?n:0,getSlug:()=>g(e("h2 a").attr("href"))}},$=async(o,e)=>{let t=await o.request({url:"/",params:{s:encodeURIComponent(e),post_type:"anime"}});if(t.status===200){let n=_cheerio.load.call(void 0, t.data);return n("ul.chivsrc li").length?n("ul.chivsrc li").map((s,r)=>B(r)).toArray():[]}return[]};var b={};var k=class{constructor(e="https://otakudesu.lol"){h.instance.defaults={baseUrl:e,headers:{"User-Agent":"Odesus/1.0"}},this.client=h.instance}async search(e){return $(this.client,e)}async getAnimeInfo(e){return A(this.client,e)}async getEpisode(e){return w(this.client,e)}async batch(e){return R(this.client,e)}};exports.Odesus = k; exports.Types = b; exports.Util = f;
